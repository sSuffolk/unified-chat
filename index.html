<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>Stream Multi Chat ðŸŽ®</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  
  <style>
    :root{
      --tab-h: 48px;
      --bg:#000; --hdr:#333; --txt:#fff; --border:#555;
      --accent:#53fc18; /* Kick Green */
      --tab-bg:#444; --tab-active:#53fc18; --tab-txt-active:#000;
      --btn:38px;
    }

    /* Layout Reset */
    html { height: 100%; background: var(--bg); }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex; flex-direction: column; 
      height: 100dvh; 
      margin: 0; padding: 0;
      background: var(--bg);
      color: #fff;
    }

    /* Header */
    header{
      background:var(--hdr); padding:8px 10px;
      padding-top: calc(8px + env(safe-area-inset-top)); 
      box-shadow:0 2px 5px rgba(0,0,0,.2); flex-shrink: 0;
    }
    .header-row{ display:flex; align-items:center; gap:8px; }
    h2{ margin:0; font-size:1.05rem; text-align:center; flex:1; }
    .toolbar{ display:flex; gap:6px; }
    
    .icon-btn{
      width:var(--btn); height:var(--btn); border:none; border-radius:50%; background:#4a4a4a; color:#fff;
      display:grid; place-items:center; cursor:pointer; font-size: 18px;
    }
    .icon-btn.primary{ background:var(--accent); color:#000; }

    /* Controls */
    .controls{
      margin-top:8px;
      display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px;
    }
    .controls input{
      padding:10px; border:1px solid var(--border); border-radius:8px; background:#222; color:#fff; 
      font-size:14px; min-width:0; outline:none;
    }
    .controls button.save{
      padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#000; 
      font-weight:bold; font-size:14px; cursor:pointer; white-space:nowrap;
    }
    
    /* Error Helper Message */
    .kick-helper {
      grid-column: span 4; font-size: 11px; color: #aaa; text-align: center; margin-top: 4px; display:none;
    }
    .kick-helper span { color: var(--accent); cursor: pointer; text-decoration: underline; }

    @media (max-width: 600px){
      .controls{ grid-template-columns: 1fr 1fr; }
      .controls button.save{ grid-column: span 2; }
      #kick-input { grid-column: span 2; }
      .kick-helper { grid-column: span 2; }
    }

    /* Chat Area */
    .chat-wrapper{ flex:1; display:flex; overflow:hidden; position: relative; }
    .chat-container{ flex:1; display:none; flex-direction:column; width: 100%; height: 100%; }
    .chat-container.active{ display:flex; }
    
    .split{ flex:1; display:flex; gap:2px; height: 100%; width: 100%; }
    @media (orientation: landscape){ .split{ flex-direction:row; } }
    @media (orientation: portrait){ .split{ flex-direction:column; } }

    .pane, .single{ flex:1; position: relative; border-right: 1px solid #333; background: #000; overflow: hidden; }
    iframe{ position: absolute; top:0; left:0; width:100%; height:100%; border:0; }

    /* Tabs */
    .tab-buttons{
      display:flex; background:var(--tab-bg);
      padding-bottom: env(safe-area-inset-bottom); 
      box-shadow:0 -2px 5px rgba(0,0,0,.15); z-index:20; 
      flex-shrink: 0; min-height: var(--tab-h); overflow-x: auto;
    }
    .tab-buttons button{ flex:1; min-width: 80px; border:none; background:transparent; color:#fff; font-size:14px; padding: 12px 0; }
    .tab-buttons button.active{ background:var(--tab-active); color: var(--tab-txt-active); font-weight: bold; }

    /* Full Screen & Modals */
    body.reading header, body.reading .tab-buttons { display:none; }
    .hotzone{ position:fixed; left:0; right:0; z-index:25; display:none; height:40px; }
    .hotzone.top{ top:0; } .hotzone.bottom{ bottom:0; }
    body.reading .hotzone{ display:block; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:50; backdrop-filter: blur(4px); }
    .modal.open{ display:flex; }
    .modal-card{ background:#161616; padding:20px; border-radius:12px; width:min(90vw, 360px); display:flex; flex-direction:column; gap:15px; border: 1px solid #333; text-align: center; }
    .row{ display:flex; gap:10px; }
    .row button{ flex:1; padding:12px; border:none; border-radius:6px; background:#333; color:#fff; cursor: pointer;}
    .qr-box{ background:#fff; padding:10px; border-radius:8px; align-self:center; }
  </style>
</head>
<body>

  <div id="hz-top" class="hotzone top"></div>
  <div id="hz-bottom" class="hotzone bottom"></div>

  <header>
    <div class="header-row">
      <div class="toolbar"><button id="btn-reading" class="icon-btn">ðŸ“–</button></div>
      <h2>Stream Multi Chat</h2>
      <div class="toolbar">
        <button id="btn-fix-kick" class="icon-btn" style="font-size:12px; width:60px; border-radius:8px; background:#333; border:1px solid #555;">Fix Kick</button>
        <button id="btn-sync" class="icon-btn primary">ðŸ“²</button>
        <button id="btn-more" class="icon-btn">â‹¯</button>
      </div>
    </div>
    <div class="controls">
      <input id="twitch-input" type="text" placeholder="Twitch Name" />
      <input id="yt-input" type="text" placeholder="YouTube ID" />
      <input id="kick-input" type="text" placeholder="Kick Name" />
      <button id="save-all" class="save">Load</button>
      <div class="kick-helper" id="kick-msg">Kick not loading? <span id="helper-click">Click here to pop it out.</span></div>
    </div>
  </header>

  <div class="chat-wrapper">
    <div id="triple" class="chat-container active">
      <div class="split">
        <div class="pane"><iframe id="tri-twitch"></iframe></div>
        <div class="pane"><iframe id="tri-youtube"></iframe></div>
        <div class="pane"><iframe id="tri-kick"></iframe></div>
      </div>
    </div>
    <div id="both" class="chat-container">
      <div class="split">
        <div class="pane"><iframe id="twitch-iframe"></iframe></div>
        <div class="pane"><iframe id="youtube-iframe"></iframe></div>
      </div>
    </div>
    <div id="twitch" class="chat-container"><div class="single"><iframe id="twitch-only-iframe"></iframe></div></div>
    <div id="youtube" class="chat-container"><div class="single"><iframe id="youtube-only-iframe"></iframe></div></div>
    <div id="kick" class="chat-container"><div class="single"><iframe id="kick-only-iframe"></iframe></div></div>
  </div>

  <div class="tab-buttons">
    <button class="active" data-tab="triple">All 3</button>
    <button data-tab="both">Twitch+YT</button>
    <button data-tab="twitch">Twitch</button>
    <button data-tab="youtube">YouTube</button>
    <button data-tab="kick">Kick</button>
  </div>

  <div id="modal-sync" class="modal">
    <div class="modal-card">
      <h3>Sync to Mobile</h3>
      <div id="qr" class="qr-box"></div>
      <button id="sync-close" style="padding:10px; background:#333; color:#fff; border:none; border-radius:4px;">Close</button>
    </div>
  </div>

  <div id="modal-more" class="modal">
    <div class="modal-card">
      <h3>Options</h3>
      <div class="row">
        <button id="popout-twitch">Open Twitch</button>
        <button id="popout-yt">Open YT</button>
        <button id="popout-kick">Open Kick</button>
      </div>
      <div class="row"><button id="reload-page">Refresh Page</button><button id="more-close">Close</button></div>
    </div>
  </div>

<script>
/* --- 1. CONFIG & REFERENCES --- */
const parentHost = window.location.hostname || '127.0.0.1';
const inputs = {
  tw: document.getElementById('twitch-input'),
  yt: document.getElementById('yt-input'),
  ki: document.getElementById('kick-input')
};
const frames = {
  tw: [document.getElementById('tri-twitch'), document.getElementById('twitch-iframe'), document.getElementById('twitch-only-iframe')],
  yt: [document.getElementById('tri-youtube'), document.getElementById('youtube-iframe'), document.getElementById('youtube-only-iframe')],
  ki: [document.getElementById('tri-kick'), document.getElementById('kick-only-iframe')]
};

/* --- 2. URL GENERATORS --- */
// Kick URL with parents to try and trick the browser
const KICK_URL = (u) => `https://kick.com/embed/chat/${u}?parent=${parentHost}&parent=localhost&parent=127.0.0.1`;
const TWITCH_URL = (u) => `https://www.twitch.tv/embed/${u}/chat?parent=${parentHost}&darkpopout`;
const YT_URL = (id) => `https://www.youtube.com/live_chat?v=${id}&is_popout=1&embed_domain=${parentHost}`;

/* --- 3. CLEANERS --- */
const cleanUser = (v) => v ? v.split(' ')[0].replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() : '';
const cleanYt = (v) => {
  if(!v) return '';
  const m = v.match(/(?:v=|youtu\.be\/|\/live\/)([A-Za-z0-9_-]{11})/);
  return m ? m[1] : v; 
};

/* --- 4. CORE LOGIC --- */
function loadAll() {
  const tUser = localStorage.getItem('twitch') || '';
  const yId = localStorage.getItem('yt') || '';
  const kUser = localStorage.getItem('kick') || '';

  inputs.tw.value = tUser;
  inputs.yt.value = yId;
  inputs.ki.value = kUser;

  // Set SRCs
  if(tUser) { const u = TWITCH_URL(tUser); frames.tw.forEach(f => { if(f.src !== u) f.src = u; }); }
  if(yId) { const u = YT_URL(yId); frames.yt.forEach(f => { if(f.src !== u) f.src = u; }); }
  
  // Kick Special Handling
  if(kUser) {
    document.getElementById('kick-msg').style.display = 'block';
    const u = KICK_URL(kUser);
    frames.ki.forEach(f => { if(f.src !== u) f.src = u; });
  } else {
    document.getElementById('kick-msg').style.display = 'none';
  }
}

// SAVE BUTTON
document.getElementById('save-all').onclick = () => {
  // 1. Clean Inputs Aggressively
  const t = cleanUser(inputs.tw.value);
  const y = cleanYt(inputs.yt.value);
  const k = cleanUser(inputs.ki.value);

  // 2. Save to Storage
  if(t) localStorage.setItem('twitch', t);
  if(y) localStorage.setItem('yt', y);
  if(k) localStorage.setItem('kick', k);

  // 3. Update Inputs visually to show what we cleaned
  inputs.tw.value = t;
  inputs.yt.value = y;
  inputs.ki.value = k;

  // 4. Reload Iframe
  loadAll();
  updateSync();
};

/* --- 5. HELPERS --- */
// Sync Logic
function updateSync() {
  const u = new URL(location.href);
  const t = localStorage.getItem('twitch');
  const y = localStorage.getItem('yt');
  const k = localStorage.getItem('kick');
  if(t) u.searchParams.set('t', t);
  if(y
