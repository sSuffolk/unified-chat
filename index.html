<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YouTube/Twitch Multi Chat üéÆ‚ú®üí¨</title>
  <link rel="icon" href="https://www.youtube.com/s/desktop/ffaa45ee/img/favicon_32.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <style>
    :root{
      --vh: 1vh;
      --tab-h: 48px;
      --bg-color:#f0f0f0; --header-bg:#333; --header-text:#fff; --input-border:#555;
      --accent:#61afef; --tab-bg:#444; --tab-active-bg:#61afef;
      --btn-size:38px;

      /* üîé Twitch zoom level (0.9 = zoomed out slightly) */
      --twitch-zoom: 0.9;
    }
    html, body { height: calc(var(--vh) * 100); }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg-color); display:flex; flex-direction:column; min-height: calc(var(--vh) * 100);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; overscroll-behavior-y:none;
    }

    /* Header */
    header{
      background:var(--header-bg); color:var(--header-text); padding:8px 10px;
      padding-top: calc(8px + env(safe-area-inset-top)); box-shadow:0 2px 5px rgba(0,0,0,.2);
    }
    .header-row{ display:flex; align-items:center; gap:8px; }
    h2{ margin:0; font-size:1.05rem; text-align:center; flex:1; }
    .toolbar{ display:flex; gap:6px; }
    .icon-btn{
      width:var(--btn-size); height:var(--btn-size); border:none; border-radius:999px; background:#4a4a4a; color:#fff;
      display:grid; place-items:center; box-shadow:0 2px 6px rgba(0,0,0,.25); cursor:pointer;
    }
    .icon-btn.primary{ background:var(--accent); }

    /* Controls */
    .controls{ margin-top:8px; display:flex; gap:8px; }
    .controls input{
      flex:1; padding:10px; border:1px solid var(--input-border); border-radius:8px; background:#222; color:#fff; font-size:15px;
    }
    .controls button.save{
      padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-size:15px; cursor:pointer;
    }

    /* Tabs */
    .tab-buttons{
      position:fixed; left:0; right:0; bottom:0; display:flex; background:var(--tab-bg);
      padding-bottom: env(safe-area-inset-bottom); box-shadow:0 -2px 5px rgba(0,0,0,.15); z-index:20; height:var(--tab-h);
    }
    .tab-buttons button{ flex:1; border:none; background:transparent; color:#fff; font-size:15px; }
    .tab-buttons button.active{ background:var(--tab-active-bg); }

    /* Chat area */
    .chat-wrapper{ flex:1; display:flex; overflow:hidden; padding-bottom: var(--tab-h); }
    .chat-container{ flex:1; display:none; flex-direction:column; }
    .chat-container.active{ display:flex; }
    .split{ flex:1; display:flex; gap:4px; padding:4px; }
    @media (orientation: portrait){ .split{ flex-direction:column; } }
    @media (orientation: landscape){ .split{ flex-direction:row; } }
    .pane{ flex:1; display:flex; min-height:0; min-width:0; }

    /* Iframes */
    iframe{ flex:1; border:0; background:#000; }

    /* üîé Twitch zoom wrapper */
    .twitch-wrap{ position:relative; overflow:hidden; width:100%; height:100%; }
    .twitch-wrap iframe{
      transform: scale(var(--twitch-zoom));
      transform-origin: top left;
      width: calc(100% / var(--twitch-zoom));
      height: calc(100% / var(--twitch-zoom));
    }

    .single{ flex:1; padding:4px; }
    .single .twitch-wrap, .single iframe{ width:100%; height:100%; }

    /* Reading mode */
    body.reading header{ display:none; }
    body.reading .tab-buttons{ transform: translateY(100%); }
    body.reading .chat-wrapper{ padding-bottom: 0; }

    /* Invisible hot zones to exit Reading mode */
    .hotzone{
      position:fixed; left:0; right:0; z-index:25; display:none;
      /* transparent but tappable */
      background:rgba(0,0,0,0); 
    }
    .hotzone.top{ top:0; height:42px; }
    .hotzone.bottom{ bottom:0; height:52px; }
    body.reading .hotzone{ display:block; }

    /* Modals */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:40; }
    .modal.open{ display:flex; }
    .modal-card{ background:#111; color:#fff; padding:16px; border-radius:12px; width:min(92vw, 420px); display:flex; flex-direction:column; gap:12px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; }
    .row button{ flex:1; min-width:120px; padding:10px; border:none; border-radius:8px; background:#333; color:#fff; }
    .qr-box{ background:#fff; padding:8px; border-radius:8px; align-self:center; }
    .modal h3{ margin:0; font-size:1rem; text-align:center; }
  </style>
</head>
<body>
  <!-- Invisible tap zones appear ONLY in Reading mode to restore UI -->
  <div id="hz-top" class="hotzone top" aria-hidden="true"></div>
  <div id="hz-bottom" class="hotzone bottom" aria-hidden="true"></div>

  <header>
    <div class="header-row">
      <div class="toolbar">
        <button id="btn-reading" class="icon-btn" title="Reading mode">üìñ</button>
      </div>
      <h2>YouTube/Twitch Multi Chat</h2>
      <div class="toolbar">
        <button id="btn-share" class="icon-btn primary" title="Share">üîó</button>
        <button id="btn-presets" class="icon-btn" title="Presets">‚≠ê</button>
        <button id="btn-wake" class="icon-btn" title="Keep Awake">üõå</button>
        <button id="btn-more" class="icon-btn" title="More">‚ãØ</button>
      </div>
    </div>
    <div class="controls">
      <input id="twitch-input" type="text" placeholder="Twitch channel"/>
      <input id="yt-input" type="text" placeholder="YouTube LIVE URL or ID"/>
      <button id="save-both" class="save">Save</button>
    </div>
  </header>

  <div class="chat-wrapper">
    <div id="both" class="chat-container active">
      <div class="split">
        <div class="pane">
          <div class="twitch-wrap"><iframe id="twitch-iframe" title="Twitch Chat"></iframe></div>
        </div>
        <div class="pane">
          <iframe id="youtube-iframe" title="YouTube Chat"></iframe>
        </div>
      </div>
    </div>

    <div id="twitch" class="chat-container">
      <div class="single">
        <div class="twitch-wrap"><iframe id="twitch-only-iframe" title="Twitch Chat (Single View)"></iframe></div>
      </div>
    </div>

    <div id="youtube" class="chat-container">
      <div class="single">
        <iframe id="youtube-only-iframe" title="YouTube Chat (Single View)"></iframe>
      </div>
    </div>
  </div>

  <div id="tabs" class="tab-buttons" role="tablist" aria-label="Chat views">
    <button class="active" data-tab="both" role="tab" aria-selected="true">Both</button>
    <button data-tab="twitch" role="tab" aria-selected="false">Twitch</button>
    <button data-tab="youtube" role="tab" aria-selected="false">YouTube</button>
  </div>

  <!-- Share Modal -->
  <div id="modal-share" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Share</h3>
      <div id="qr" class="qr-box"></div>
      <div class="row"><button id="share-copy">Copy Link</button><button id="share-close">Close</button></div>
    </div>
  </div>

  <!-- Presets Modal -->
  <div id="modal-presets" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Presets</h3>
      <div class="row"><button id="save-a">Save ‚Üí A</button><button id="load-a">Load A</button></div>
      <div class="row"><button id="save-b">Save ‚Üí B</button><button id="load-b">Load B</button></div>
      <div class="row"><button id="presets-close">Close</button></div>
    </div>
  </div>

  <!-- More Modal -->
  <div id="modal-more" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>More</h3>
      <div class="row"><button id="popout-twitch-chat">Twitch Chat üöÄ</button><button id="popout-yt-chat">YouTube Chat üöÄ</button></div>
      <div class="row"><button id="popout-twitch-stream">Twitch Stream ‚ñ∂Ô∏è</button><button id="popout-yt-stream">YouTube Stream ‚ñ∂Ô∏è</button></div>
      <div class="row"><button id="more-close">Close</button></div>
    </div>
  </div>

<script>
/* ========== Elements ========== */
const twitchInput=document.getElementById('twitch-input');
const ytInput=document.getElementById('yt-input');
const saveBtn=document.getElementById('save-both');

const tabs=document.querySelectorAll('.tab-buttons button');
const containers=document.querySelectorAll('.chat-container');

const twitchIframe=document.getElementById('twitch-iframe');
const twitchOnly=document.getElementById('twitch-only-iframe');
const ytIframe=document.getElementById('youtube-iframe');
const ytOnly=document.getElementById('youtube-only-iframe');

const btnReading=document.getElementById('btn-reading');
const btnShare=document.getElementById('btn-share');
const btnPresets=document.getElementById('btn-presets');
const btnWake=document.getElementById('btn-wake');
const btnMore=document.getElementById('btn-more');

const modalShare=document.getElementById('modal-share');
const modalPresets=document.getElementById('modal-presets');
const modalMore=document.getElementById('modal-more');
const qrBox=document.getElementById('qr');

const hzTop=document.getElementById('hz-top');
const hzBottom=document.getElementById('hz-bottom');

/* ========== Helpers ========== */
const parentHost=window.location.hostname||'127.0.0.1';
const TWITCH_EMBED=(ch)=>`https://www.twitch.tv/embed/${ch}/chat?parent=${parentHost}&darkpopout`;
const YT_CHAT=(id)=>`https://www.youtube.com/live_chat?v=${id}&is_popout=1&embed_domain=${parentHost}`;
const sanitizeTwitch=(c)=>c.replace(/[^a-zA-Z0-9_]/g,'').toLowerCase();
function extractYtId(v){if(!v)return'';const r=/^[A-Za-z0-9_-]{11}$/;if(r.test(v))return v;const m=v.match(/(?:v=|\/)([A-Za-z0-9_-]{11})/);return m?m[1]:'';}

function buildShareUrl(tw=(localStorage.getItem('twitchChannel')||''), yt=(localStorage.getItem('ytId')||'')){
  const u=new URL(location.href);
  if(tw) u.searchParams.set('twitch',tw); else u.searchParams.delete('twitch');
  if(yt) u.searchParams.set('yt',yt); else u.searchParams.delete('yt');
  return u.toString();
}
function applyFromUrl(){
  const p=new URLSearchParams(location.search);
  const tw=p.get('twitch'); const yt=p.get('yt');
  if(tw) localStorage.setItem('twitchChannel',sanitizeTwitch(tw));
  if(yt) localStorage.setItem('ytId',extractYtId(yt));
}
function updateUrl(){ history.replaceState(null,'',buildShareUrl()); }

/* ========== Load iframes ========== */
function loadChats(){
  const tw=localStorage.getItem('twitchChannel')||'';
  const yt=localStorage.getItem('ytId')||'';
  if(tw){
    const s=TWITCH_EMBED(tw);
    if(twitchIframe.src!==s) twitchIframe.src=s;
    if(twitchOnly.src!==s) twitchOnly.src=s;
    twitchInput.value=tw;
  }
  if(yt){
    const s=YT_CHAT(yt);
    if(ytIframe.src!==s) ytIframe.src=s;
    if(ytOnly.src!==s) ytOnly.src=s;
    ytInput.value=yt;
  }
}

/* ========== Save ========== */
saveBtn.onclick=()=>{
  const tw=sanitizeTwitch(twitchInput.value.trim());
  const yt=extractYtId(ytInput.value.trim());
  if(tw) localStorage.setItem('twitchChannel',tw);
  if(yt) localStorage.setItem('ytId',yt);
  loadChats(); updateUrl();
};

/* ========== Tabs ========== */
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
    containers.forEach(c=>c.classList.remove('active'));
    btn.classList.add('active'); btn.setAttribute('aria-selected','true');
    document.getElementById(btn.dataset.tab).classList.add('active');
  },{passive:true});
});

/* ========== Reading mode ========== */
function setReading(on){
  document.body.classList.toggle('reading',on);
  localStorage.setItem('reading',on?'1':'0');
}
btnReading.onclick=()=> setReading(!document.body.classList.contains('reading'));

/* Tap top or bottom edge to exit reading mode */
function exitReadingIfNeeded(){
  if(document.body.classList.contains('reading')) setReading(false);
}
hzTop.addEventListener('click', exitReadingIfNeeded);
hzBottom.addEventListener('click', exitReadingIfNeeded);

/* ========== Wake Lock ========== */
let wake=null;
async function reqWake(){ try{ wake=await navigator.wakeLock?.request('screen'); btnWake.textContent='‚úÖ'; wake.addEventListener?.('release',()=>btnWake.textContent='üõå'); }catch{} }
async function relWake(){ try{ await wake?.release(); }catch{} finally{ wake=null; btnWake.textContent='üõå'; } }
btnWake.onclick=()=> wake?relWake():reqWake();
document.addEventListener('visibilitychange',()=>{ if(wake && document.visibilityState==='visible') reqWake(); });

/* ========== Share modal (QR + Copy) ========== */
btnShare.onclick=()=>{
  modalShare.classList.add('open');
  qrBox.innerHTML='';
  new QRCode(qrBox,{text:buildShareUrl(),width:200,height:200});
};
document.getElementById('share-copy').onclick=()=>navigator.clipboard.writeText(buildShareUrl());
document.getElementById('share-close').onclick=()=>modalShare.classList.remove('open');
modalShare.addEventListener('click',(e)=>{ if(e.target===modalShare) modalShare.classList.remove('open'); });

/* ========== Presets modal ========== */
btnPresets.onclick=()=>modalPresets.classList.add('open');
document.getElementById('presets-close').onclick=()=>modalPresets.classList.remove('open');
document.getElementById('save-a').onclick=()=>{localStorage.setItem('pa_tw',localStorage.getItem('twitchChannel')||'');localStorage.setItem('pa_yt',localStorage.getItem('ytId')||'');};
document.getElementById('load-a').onclick=()=>{localStorage.setItem('twitchChannel',localStorage.getItem('pa_tw')||'');localStorage.setItem('ytId',localStorage.getItem('pa_yt')||'');loadChats();updateUrl();};
document.getElementById('save-b').onclick=()=>{localStorage.setItem('pb_tw',localStorage.getItem('twitchChannel')||'');localStorage.setItem('pb_yt',localStorage.getItem('ytId')||'');};
document.getElementById('load-b').onclick=()=>{localStorage.setItem('twitchChannel',localStorage.getItem('pb_tw')||'');localStorage.setItem('ytId',localStorage.getItem('pb_yt')||'');loadChats();updateUrl();};
modalPresets.addEventListener('click',(e)=>{ if(e.target===modalPresets) modalPresets.classList.remove('open'); });

/* ========== More (popouts) ========== */
btnMore.onclick=()=>modalMore.classList.add('open');
document.getElementById('more-close').onclick=()=>modalMore.classList.remove('open');
modalMore.addEventListener('click',(e)=>{ if(e.target===modalMore) modalMore.classList.remove('open'); });

document.getElementById('popout-twitch-chat').onclick=()=>{
  const tw=localStorage.getItem('twitchChannel'); if(!tw) return alert('Save a Twitch channel first.');
  window.open(`https://www.twitch.tv/popout/${tw}/chat?popout=`,'_blank','noopener');
};
document.getElementById('popout-yt-chat').onclick=()=>{
  const yt=localStorage.getItem('ytId'); if(!yt) return alert('Save your YouTube LIVE ID first.');
  window.open(YT_CHAT(yt),'_blank','noopener');
};
document.getElementById('popout-twitch-stream').onclick=()=>{
  const tw=localStorage.getItem('twitchChannel'); if(!tw) return alert('Save a Twitch channel first.');
  window.open(`https://player.twitch.tv/?channel=${tw}&parent=${parentHost}`,'_blank','noopener');
};
document.getElementById('popout-yt-stream').onclick=()=>{
  const yt=localStorage.getItem('ytId'); if(!yt) return alert('Save your YouTube LIVE ID first.');
  window.open(`https://www.youtube.com/embed/${yt}?autoplay=1&modestbranding=1&rel=0`,'_blank','noopener');
};

/* ========== Init ========== */
function setVH(){ document.documentElement.style.setProperty('--vh', `${window.innerHeight*0.01}px`); }
applyFromUrl(); loadChats(); updateUrl();
if(localStorage.getItem('reading')==='1') document.body.classList.add('reading');
setVH(); window.addEventListener('resize', setVH);
</script>
</body>
</html>