<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  
  <!-- iOS Full Screen / PWA Capabilities -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Stream Multi Chat ðŸŽ®</title>
  <link rel="icon" href="https://www.youtube.com/s/desktop/ffaa45ee/img/favicon_32.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  
  <style>
    :root{
      --tab-h: 48px;
      --bg:#000; --hdr:#333; --txt:#fff; --border:#555;
      --accent:#61afef; --tab-bg:#444; --tab-active:#61afef;
      --btn:38px;
    }

    /* Layout Reset */
    html { height: 100%; background: var(--bg); }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display: flex; flex-direction: column; 
      height: 100dvh; /* Mobile browser friendly height */
      margin: 0; padding: 0;
      background: var(--bg);
      -webkit-font-smoothing: antialiased; 
      text-rendering: optimizeLegibility; 
      
      /* Handle iPhone 16 Landscape Notch/Island */
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* Header */
    header{
      background:var(--hdr); color:var(--txt); padding:8px 10px;
      padding-top: calc(8px + env(safe-area-inset-top)); 
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      flex-shrink: 0;
    }
    .header-row{ display:flex; align-items:center; gap:8px; }
    h2{ margin:0; font-size:1.05rem; text-align:center; flex:1; }
    .toolbar{ display:flex; gap:6px; }
    
    .icon-btn{
      width:var(--btn); height:var(--btn); border:none; border-radius:999px; background:#4a4a4a; color:#fff;
      display:grid; place-items:center; box-shadow:0 2px 6px rgba(0,0,0,.25); cursor:pointer;
    }
    .icon-btn.primary{ background:var(--accent); }

    /* Inputs */
    .controls{
      margin-top:8px;
      display:grid; grid-template-columns: 1fr 1fr auto; gap:8px;
    }
    .controls input{
      padding:10px; border:1px solid var(--border); border-radius:8px; background:#222; color:#fff; 
      font-size:16px; /* Prevents iOS Zoom */
      min-width:0;
    }
    .controls button.save{
      padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-size:15px; cursor:pointer;
      white-space:nowrap;
    }
    @media (max-width: 560px){
      .controls{ grid-template-columns: 1fr; }
      .controls button.save{ width:100%; }
    }

    /* Chat Area */
    .chat-wrapper{ flex:1; display:flex; overflow:hidden; position: relative; }
    .chat-container{ flex:1; display:none; flex-direction:column; width: 100%; height: 100%; }
    .chat-container.active{ display:flex; }
    
    .split{ flex:1; display:flex; gap:2px; padding:0; height: 100%; width: 100%; }
    @media (orientation: landscape){ .split{ flex-direction:row; } }
    @media (orientation: portrait){ .split{ flex-direction:column; } }

    .pane, .single{ flex:1; display:flex; position: relative; width: 100%; height: 100%; overflow: hidden; }
    iframe{ position: absolute; top:0; left:0; width:100%; height:100%; background:#000; border:0; }

    /* Tabs */
    .tab-buttons{
      display:flex; background:var(--tab-bg);
      padding-bottom: env(safe-area-inset-bottom); 
      box-shadow:0 -2px 5px rgba(0,0,0,.15); z-index:20; 
      flex-shrink: 0; min-height: var(--tab-h);
    }
    .tab-buttons button{ flex:1; border:none; background:transparent; color:#fff; font-size:15px; padding: 12px 0; }
    .tab-buttons button.active{ background:var(--tab-active); }

    /* Reading Mode */
    body.reading header, body.reading .tab-buttons { display:none; }
    .hotzone{ position:fixed; left:0; right:0; z-index:25; display:none; background:transparent; height:40px; }
    .hotzone.top{ top:0; } .hotzone.bottom{ bottom:0; }
    body.reading .hotzone{ display:block; }

    /* Modals */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:40; backdrop-filter: blur(3px); }
    .modal.open{ display:flex; }
    .modal-card{ background:#161616; color:#fff; padding:20px; border-radius:14px; width:min(90vw, 400px); display:flex; flex-direction:column; gap:12px; border: 1px solid #333; text-align: center; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; }
    .row button{ flex:1; padding:12px; border:none; border-radius:8px; background:#333; color:#fff; font-size: 16px; cursor: pointer;}
    .qr-box{ background:#fff; padding:10px; border-radius:8px; align-self:center; margin: 10px 0; }
    .modal h3{ margin:0; }
    .modal p { color: #aaa; margin:0; font-size: 0.9rem; }

  </style>
</head>
<body>

  <!-- Hidden triggers to exit full screen mode -->
  <div id="hz-top" class="hotzone top"></div>
  <div id="hz-bottom" class="hotzone bottom"></div>

  <header>
    <div class="header-row">
      <div class="toolbar">
        <button id="btn-reading" class="icon-btn" title="Full Screen Mode">ðŸ“–</button>
      </div>
      <h2>Stream Multi Chat</h2>
      <div class="toolbar">
        <!-- The Sync Button -->
        <button id="btn-sync" class="icon-btn primary" title="Sync to Phone">ðŸ“²</button>
        <button id="btn-more" class="icon-btn" title="More">â‹¯</button>
      </div>
    </div>
    <div class="controls">
      <input id="twitch-input" type="text" placeholder="Twitch Channel" />
      <input id="yt-input" type="text" placeholder="YT Link or ID" />
      <button id="save-both" class="save">Load</button>
    </div>
  </header>

  <div class="chat-wrapper">
    <div id="both" class="chat-container active">
      <div class="split">
        <div class="pane"><iframe id="twitch-iframe"></iframe></div>
        <div class="pane"><iframe id="youtube-iframe"></iframe></div>
      </div>
    </div>
    <div id="twitch" class="chat-container">
      <div class="single"><iframe id="twitch-only-iframe"></iframe></div>
    </div>
    <div id="youtube" class="chat-container">
      <div class="single"><iframe id="youtube-only-iframe"></iframe></div>
    </div>
  </div>

  <div id="tabs" class="tab-buttons">
    <button class="active" data-tab="both">Both</button>
    <button data-tab="twitch">Twitch</button>
    <button data-tab="youtube">YouTube</button>
  </div>

  <!-- SYNC Modal -->
  <div id="modal-sync" class="modal">
    <div class="modal-card">
      <h3>Sync to iPhone</h3>
      <p>Scan this on your phone to load these channels automatically.</p>
      <div id="qr" class="qr-box"></div>
      <div class="row">
        <button id="sync-close">Done</button>
      </div>
    </div>
  </div>

  <!-- More Modal -->
  <div id="modal-more" class="modal">
    <div class="modal-card">
      <h3>Options</h3>
      <div class="row">
        <button id="popout-twitch-stream">Watch Twitch</button>
        <button id="popout-yt-stream">Watch YT</button>
      </div>
      <div class="row"><button id="reload-page">Refresh Page</button><button id="more-close">Close</button></div>
    </div>
  </div>

<script>
/* --- 1. Variables --- */
const twitchInput = document.getElementById('twitch-input');
const ytInput = document.getElementById('yt-input');
const saveBtn = document.getElementById('save-both');
const twitchIframe = document.getElementById('twitch-iframe');
const twitchOnly = document.getElementById('twitch-only-iframe');
const ytIframe = document.getElementById('youtube-iframe');
const ytOnly = document.getElementById('youtube-only-iframe');
const parentHost = window.location.hostname || '127.0.0.1';

/* --- 2. URL Generators --- */
const TWITCH_EMBED = (ch) => `https://www.twitch.tv/embed/${ch}/chat?parent=${parentHost}&darkpopout`;
const YT_CHAT = (id) => `https://www.youtube.com/live_chat?v=${id}&is_popout=1&embed_domain=${parentHost}`;

const sanitizeTwitch = (c) => c.replace(/[^a-zA-Z0-9_]/g,'').toLowerCase();
const extractYtId = (v) => {
  if(!v) return '';
  const m = v.match(/(?:v=|youtu\.be\/|\/live\/)([A-Za-z0-9_-]{11})/);
  return m ? m[1] : v; 
};

/* --- 3. Core Logic: Save & Load --- */
function loadChats() {
  const tw = localStorage.getItem('twitchChannel') || '';
  const yt = localStorage.getItem('ytId') || '';

  if (tw) {
    const url = TWITCH_EMBED(tw);
    if(twitchIframe.src !== url) twitchIframe.src = url;
    if(twitchOnly.src !== url) twitchOnly.src = url;
    twitchInput.value = tw;
  }
  if (yt) {
    const url = YT_CHAT(yt);
    if(ytIframe.src !== url) ytIframe.src = url;
    if(ytOnly.src !== url) ytOnly.src = url;
    ytInput.value = yt;
  }
}

// Button Click
saveBtn.onclick = () => {
  const tw = sanitizeTwitch(twitchInput.value.trim());
  const yt = extractYtId(ytInput.value.trim());
  
  if(tw) localStorage.setItem('twitchChannel', tw);
  if(yt) localStorage.setItem('ytId', yt);
  
  loadChats();
  updateSyncUrl(); // Update URL bar for easy copying
};

/* --- 4. Sync Logic (Desktop -> Phone) --- */
function buildSyncUrl() {
  const u = new URL(location.href);
  const tw = localStorage.getItem('twitchChannel');
  const yt = localStorage.getItem('ytId');
  if (tw) u.searchParams.set('twitch', tw);
  if (yt) u.searchParams.set('yt', yt);
  return u.toString();
}

function updateSyncUrl() {
  history.replaceState(null, '', buildSyncUrl());
}

// On Page Load: Check if we are the phone receiving data
const p = new URLSearchParams(location.search);
const incomingTwitch = p.get('twitch');
const incomingYt = p.get('yt');

if (incomingTwitch || incomingYt) {
  if(incomingTwitch) localStorage.setItem('twitchChannel', sanitizeTwitch(incomingTwitch));
  if(incomingYt) localStorage.setItem('ytId', extractYtId(incomingYt));
  
  // Clean URL so the user doesn't see ugly parameters forever
  window.history.replaceState({}, document.title, window.location.pathname);
}

// Load whatever is in storage (whether existing or just saved from URL)
loadChats();

/* --- 5. UI Interactivity --- */

// Tabs
const tabs = document.querySelectorAll('.tab-buttons button');
const containers = document.querySelectorAll('.chat-container');
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    containers.forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// Reading Mode
const btnReading = document.getElementById('btn-reading');
const hzTop = document.getElementById('hz-top');
const hzBottom = document.getElementById('hz-bottom');
const setReading = (on) => { document.body.classList.toggle('reading', on); };

btnReading.onclick = () => setReading(!document.body.classList.contains('reading'));
hzTop.onclick = () => setReading(false);
hzBottom.onclick = () => setReading(false);

// Sync Modal
const modalSync = document.getElementById('modal-sync');
const qrBox = document.getElementById('qr');
const btnSync = document.getElementById('btn-sync');

btnSync.onclick = () => {
  updateSyncUrl(); // Ensure URL is fresh
  modalSync.classList.add('open');
  qrBox.innerHTML = '';
  // Generate QR pointing to the current URL with Params
  new QRCode(qrBox, { text: buildSyncUrl(), width: 200, height: 200 });
};
document.getElementById('sync-close').onclick = () => modalSync.classList.remove('open');

// More Modal
const modalMore = document.getElementById('modal-more');
document.getElementById('btn-more').onclick = () => modalMore.classList.add('open');
document.getElementById('more-close').onclick = () => modalMore.classList.remove('open');
document.getElementById('reload-page').onclick = () => location.reload();

// External Links
document.getElementById('popout-twitch-stream').onclick = () => {
  const tw = localStorage.getItem('twitchChannel');
  if(tw) window.open(`https://player.twitch.tv/?channel=${tw}&parent=${parentHost}`, '_blank');
};
document.getElementById('popout-yt-stream').onclick = () => {
  const yt = localStorage.getItem('ytId');
  if(yt) window.open(`https://www.youtube.com/embed/${yt}?autoplay=1`, '_blank');
};

// Close modals on background click
[modalSync, modalMore].forEach(m => {
  m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); });
});

</script>
</body>
</html>
