<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YouTube/Twitch Multi Chat üéÆ‚ú®</title>
  <link rel="icon" href="https://www.youtube.com/s/desktop/ffaa45ee/img/favicon_32.png" type="image/png">
  <style>
    :root{
      --vh: 1vh;                 
      --tab-h: 56px;             
      --bg-color:#f0f0f0; --header-bg:#333; --header-text:#fff; --input-border:#ccc;
      --button-primary-bg:#61afef; --button-primary-hover:#529dce;
      --button-secondary-bg:#98c379; --button-secondary-hover:#7ca95e;
      --tab-bg:#444; --tab-active-bg:#61afef;
      --radius:12px;
    }

    html, body { height: calc(var(--vh) * 100); }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg-color);
      display:flex; flex-direction:column;
      min-height: calc(var(--vh) * 100);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      overscroll-behavior-y:none;
    }

    header{
      background:var(--header-bg); color:var(--header-text);
      padding:10px 8px;
      padding-top: calc(10px + env(safe-area-inset-top));
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      position:relative; z-index:10;
    }
    header h2{
      margin:0 0 8px;
      font-size:1.15rem;
      letter-spacing:.2px;
      text-align:center;
      width:100%;
    }
    .controls{
      margin-bottom:8px; display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:8px;
    }
    .controls input[type="text"]{
      flex:1 1 240px; max-width:420px; padding:10px 10px; border:1px solid var(--input-border);
      border-radius:8px; font-size:16px; box-sizing:border-box; background:#fff;
    }
    .controls button{
      padding:10px 14px; font-size:16px; border:none; border-radius:10px;
      background:var(--button-primary-bg); color:var(--header-text); cursor:pointer; touch-action:manipulation;
    }
    .controls button:active{ transform:translateY(1px); }
    .controls button:hover{ background:var(--button-primary-hover); }

    .popouts{ margin-top:8px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px; }
    .popouts button{
      padding:10px 14px; font-size:15px; border:none; border-radius:10px;
      background:var(--button-secondary-bg); color:var(--header-text); cursor:pointer; touch-action:manipulation;
    }
    .popouts button:active{ transform:translateY(1px); }
    .popouts button:hover{ background:var(--button-secondary-hover); }

    .tab-buttons{
      position:fixed; left:0; right:0; bottom:0;
      display:flex; justify-content:center; background:var(--tab-bg);
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow:0 -2px 5px rgba(0,0,0,.15);
      z-index:20;
      transition: transform .2s ease-in-out;
    }
    .tab-buttons button{
      flex:1; padding:14px 10px; border:none; background:transparent; color:var(--header-text);
      font-size:16px; cursor:pointer; touch-action:manipulation;
    }
    .tab-buttons button.active{ background:var(--tab-active-bg); }

    .chat-wrapper{
      flex:1 1 auto; display:flex; overflow:hidden;
      min-height:0;
      padding-bottom: var(--tab-h);
    }
    .chat-container{
      width:100%; height:100%; display:none; flex-direction:column;
      min-height:0;
    }
    .chat-container.active{ display:flex; }
    .split{
      display:flex; flex-direction:column; width:100%; height:100%;
      gap:4px;
      padding:4px;
      min-height:0;
    }
    .single{ height:100%; min-height:0; padding:4px; }
    iframe{
      display:block; width:100%; border:0; background:#000; box-shadow:inset 0 0 5px rgba(0,0,0,.08); min-height:0;
    }
    .split iframe{ flex:1 1 0; }
    .single iframe{ height:100%; }

    @media (orientation: landscape){
      .split{ flex-direction:row; }
    }

    body.compact header{ display:none; }
    body.compact .fab{ opacity:.9; }

    .tabs-hidden .tab-buttons{ transform: translateY(100%); }
    .tabs-hidden .chat-wrapper{ padding-bottom: 0; }

    .fab{
      position:fixed; top:calc(env(safe-area-inset-top) + 8px); right:8px; z-index:30;
      background:var(--tab-active-bg); color:#fff; border:none; border-radius:999px;
      padding:10px 12px; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.25);
      touch-action:manipulation;
    }
    .fab:active{ transform:translateY(1px); }
  </style>
</head>
<body>
  <button id="toggle-compact" class="fab" aria-label="Toggle compact UI">‚öôÔ∏è</button>
  <button id="toggle-tabs" class="fab" style="right:auto; left:8px;" aria-label="Toggle bottom tabs">‚¨áÔ∏è</button>

  <header>
    <h2>YouTube/Twitch Multi Chat üéÆ‚ú®üí¨</h2>
    <div class="controls">
      <input id="twitch-input" type="text" placeholder="Enter Twitch channel name" aria-label="Twitch channel"/>
      <button id="save-twitch-btn">Save Twitch</button>
      <input id="yt-input" type="text" placeholder="Paste YouTube LIVE URL or 11-char ID" aria-label="YouTube Live Chat URL or ID"/>
      <button id="save-btn">Save YouTube</button>
    </div>
    <div class="popouts">
      <button id="popout-twitch" aria-label="Launch Twitch chat in new window">Twitch Chat üöÄ</button>
      <button id="popout-youtube" aria-label="Launch YouTube chat in new window">YouTube Chat üöÄ</button>
      <button id="popout-twitch-stream" aria-label="Launch Twitch stream in new window">Twitch Stream ‚ñ∂Ô∏è</button>
      <button id="popout-youtube-stream" aria-label="Launch YouTube stream in new window">YouTube Stream ‚ñ∂Ô∏è</button>
    </div>
  </header>

  <div class="chat-wrapper">
    <div id="both" class="chat-container active">
      <div class="split">
        <iframe id="twitch-iframe" title="Twitch Chat"></iframe>
        <iframe id="youtube-iframe" title="YouTube Chat"></iframe>
      </div>
    </div>

    <div id="twitch" class="chat-container">
      <div class="single">
        <iframe id="twitch-only-iframe" title="Twitch Chat (Single View)"></iframe>
      </div>
    </div>

    <div id="youtube" class="chat-container">
      <div class="single">
        <iframe id="youtube-only-iframe" title="YouTube Chat (Single View)"></iframe>
      </div>
    </div>
  </div>

  <div id="tabs" class="tab-buttons" role="tablist" aria-label="Chat views">
    <button class="active" data-tab="both" role="tab" aria-selected="true">Both</button>
    <button data-tab="twitch" role="tab" aria-selected="false">Twitch</button>
    <button data-tab="youtube" role="tab" aria-selected="false">YouTube</button>
  </div>

  <script>
    const twitchInput = document.getElementById('twitch-input');
    const saveTwitchBtn = document.getElementById('save-twitch-btn');
    const ytInput = document.getElementById('yt-input');
    const saveBtn = document.getElementById('save-btn');
    const tabButtons = document.querySelectorAll('.tab-buttons button');
    const tabsBar = document.getElementById('tabs');
    const popoutTwitchBtn = document.getElementById('popout-twitch');
    const popoutYoutubeBtn = document.getElementById('popout-youtube');
    const popoutTwitchStreamBtn = document.getElementById('popout-twitch-stream');
    const popoutYoutubeStreamBtn = document.getElementById('popout-youtube-stream');
    const twitchIframe = document.getElementById('twitch-iframe');
    const twitchOnlyIframe = document.getElementById('twitch-only-iframe');
    const youtubeIframe = document.getElementById('youtube-iframe');
    const youtubeOnlyIframe = document.getElementById('youtube-only-iframe');
    const compactBtn = document.getElementById('toggle-compact');
    const hideTabsBtn = document.getElementById('toggle-tabs');

    const DEFAULT_TWITCH_CHANNEL = 'suffolk';
    const sanitizeTwitchChannel = (channel) => channel.replace(/[^a-zA-Z0-9_]/g, '').toLowerCase();
    const getTwitchChannel = () => {
      const stored = localStorage.getItem('twitchChannel');
      const sanitized = stored ? sanitizeTwitchChannel(stored) : '';
      return sanitized || DEFAULT_TWITCH_CHANNEL;
    };
    const parentHost = window.location.hostname || '127.0.0.1';
    const TWITCH_EMBED = (channel) => `https://www.twitch.tv/embed/${channel}/chat?parent=${parentHost}&darkpopout`;
    const YT_CHAT = (id) => 'https://www.youtube.com/live_chat?v=' + id + '&is_popout=1&embed_domain=' + (window.location.hostname || '127.0.0.1');

    function extractYtId(input) {
      if (!input) return '';
      const idRegex = /^[A-Za-z0-9_-]{11}$/;
      if (idRegex.test(input)) return input;
      const urlRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|live\/|embed\/|shorts\/|v\/)?([A-Za-z0-9_-]{11})/i;
      const m = input.match(urlRegex);
      return m && m[1] ? m[1] : '';
    }

    function setViewportVars(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const tabsHidden = document.body.classList.contains('tabs-hidden');
      const tabHeight = tabsHidden ? 0 : (tabsBar?.offsetHeight || 56);
      document.documentElement.style.setProperty('--tab-h', `${tabHeight}px`);
    }

    function loadChats() {
      const ytId = localStorage.getItem('ytId') || '';
      const twitchChannel = getTwitchChannel();

      const twitchSrc = TWITCH_EMBED(twitchChannel);
      if (twitchIframe.src !== twitchSrc) twitchIframe.src = twitchSrc;
      if (twitchOnlyIframe.src !== twitchSrc) twitchOnlyIframe.src = twitchSrc;
      twitchInput.value = twitchChannel;

      if (ytId) {
        const src = YT_CHAT(ytId);
        if (youtubeIframe.src !== src) youtubeIframe.src = src;
        if (youtubeOnlyIframe.src !== src) youtubeOnlyIframe.src = src;
        ytInput.value = ytId;
      } else {
        youtubeIframe.src = '';
        youtubeOnlyIframe.src = '';
        ytInput.value = '';
      }
    }

    saveTwitchBtn.addEventListener('click', () => {
      const channel = twitchInput.value.trim();
      if (!channel) return alert('Please enter a Twitch channel name.');
      const sanitized = sanitizeTwitchChannel(channel);
      if (!sanitized) return alert('Please enter a valid Twitch channel name.');
      localStorage.setItem('twitchChannel', sanitized);
      loadChats();
      alert('Twitch channel saved.');
    });

    saveBtn.addEventListener('click', () => {
      const id = extractYtId(ytInput.value.trim());
      if (!id) return alert('Please paste your actual LIVE URL or the 11-character video ID.');
      localStorage.setItem('ytId', id);
      loadChats();
      alert('YouTube ID saved.');
    });

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        tabButtons.forEach((b) => {
          b.classList.remove('active');
          b.setAttribute('aria-selected','false');
        });
        document.querySelectorAll('.chat-container').forEach((c) => c.classList.remove('active'));
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
        const tab = btn.getAttribute('data-tab');
        document.getElementById(tab)?.classList.add('active');
      }, { passive: true });
    });

    // Chat popouts
    popoutTwitchBtn.addEventListener('click', () => {
      const channel = getTwitchChannel();
      window.open(`https://www.twitch.tv/popout/${channel}/chat?popout=`, '_blank', 'noopener');
    });
    popoutYoutubeBtn.addEventListener('click', () => {
      const id = localStorage.getItem('ytId');
      if (!id) return alert('Save your YouTube LIVE ID first.');
      window.open(YT_CHAT(id), '_blank', 'noopener');
    });

    // Stream popouts
    popoutTwitchStreamBtn.addEventListener('click', () => {
      const channel = getTwitchChannel();
      const url = `https://player.twitch.tv/?channel=${channel}&parent=${parentHost}`;
      window.open(url, '_blank', 'noopener');
    });
    popoutYoutubeStreamBtn.addEventListener('click', () => {
      const id = localStorage.getItem('ytId');
      if (!id) return alert('Save your YouTube LIVE ID first.');
      const url = `https://www.youtube.com/embed/${id}?autoplay=1&modestbranding=1&rel=0`;
      window.open(url, '_blank', 'noopener');
    });

    function applyCompactFromStorage(){
      const compact = localStorage.getItem('compactUI') === '1';
      document.body.classList.toggle('compact', compact);
    }
    compactBtn.addEventListener('click', () => {
      const next = !document.body.classList.contains('compact');
      document.body.classList.toggle('compact', next);
      localStorage.setItem('compactUI', next ? '1' : '0');
      setViewportVars();
    });

    function applyTabsHiddenFromStorage(){
      const hidden = localStorage.getItem('hideTabs') === '1';
      document.body.classList.toggle('tabs-hidden', hidden);
    }
    hideTabsBtn.addEventListener('click', () => {
      const next = !document.body.classList.contains('tabs-hidden');
      document.body.classList.toggle('tabs-hidden', next);
      localStorage.setItem('hideTabs', next ? '1' : '0');
      setViewportVars();
    });

    document.addEventListener('DOMContentLoaded', () => {
      applyCompactFromStorage();
      applyTabsHiddenFromStorage();
      setViewportVars();
      loadChats();
      const isPhone = Math.max(window.screen.width, window.screen.height) < 1280;
      if (isPhone && window.matchMedia('(orientation: landscape)').matches && !localStorage.getItem('compactUI')) {
        document.body.classList.add('compact');
        localStorage.setItem('compactUI','1');
        setViewportVars();
      }
    });

    window.addEventListener('resize', setViewportVars);
    window.addEventListener('orientationchange', () => setTimeout(setViewportVars, 200));
  </script>
</body>
</html>
